<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Bataille navale</title>
        <style>
        </style>
    </head>
 
    <body>
	
	 <canvas id="canvas" width="1000" height="700"> </canvas>

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>

			
		<script type="text/javascript" src="bateau.js"></script>
		<script>
			
			function Tir(x,y) 
			{
			  this.x = x;
			  this.y = y;
			  this.time = new Date().getTime();
			}

			function distance(x1,y1,x2,y2)
			{
				return Math.sqrt((x2-x1)*(x2-x1) + (y2-y1)*(y2-y1));
			}
			
			document.oncontextmenu = new Function("return false");
			
			// Connexion socket.io
            var socket = io.connect('http://localhost:8080');
			socket.emit('nouveau_joueur');
			var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext("2d");
			var listBateaux = [];
			var tirs = [];
			var idJoueur;
			
			var sourisX = 0;
			var sourisY = 0;
			var select = -1;
			
			canvas.width = window.innerHeight;
			canvas.height = window.innerHeight;

            // mouvement souris
			canvas.addEventListener("mousemove", function(e)
			{
				sourisX = e.pageX - 10;
				sourisY = e.pageY - 10;
			});

			document.oncontextmenu = new Function("return false");			
			
			// clic souris
			canvas.addEventListener("mousedown", function(e)
			{
				if (e.which == 1) // bouton gauche
				{
					// Soit on selectionne un bateau, soit on tire.
					for (var i=0; i<listBateaux.length; i=i+1)
					{

						var selected = false;
						if (listBateaux[i].joueur == idJoueur && distance(listBateaux[i].x(), listBateaux[i].y(), sourisX/ratio, sourisY/ratio) < 5)
						{
							select = listBateaux[i].id;
							selected = true;
							break;
						}
					}	
					if (selected == false)
					{
						socket.emit('tir', sourisX/ratio, sourisY/ratio);
					}
				}
				else if (e.which == 3) // bouton droit
				{
					if (select != -1)
						socket.emit('move', select, sourisX/ratio, sourisY/ratio);
				}
			});		
			
			var ratio = canvas.width/100; // Le ratio des éléments à placer selon la taille du jeu.
			
			socket.on('infosPartie', function(num) {
				idJoueur = num;				
			});			
			
			socket.on('bateau', function(id,px,py,pspeed) {
				listBateaux.push(new Bateau(id,px,py,idJoueur,pspeed));
			});

			socket.on('move', function(id,px,py) {	
				for (var i=0; i<listBateaux.length;i=i+1)
				{
					if (listBateaux[i].id == id) //
					{
						listBateaux[i].x_dep = listBateaux[i].x();
						listBateaux[i].y_dep = listBateaux[i].y();
						listBateaux[i].x_dest = px;
						listBateaux[i].y_dest = py;
						listBateaux[i].time_move = new Date().getTime();
					}
				}
			});

			
			socket.on('jeu', function () {		
				initialiser();
				setInterval(dessiner, 1000/30);								
			});

			socket.on('tir', function (x,y) {	
				tirs.push(new Tir(x,y));			
			});

			socket.on('destruction', function (id) {				
				for (var i=0; i<listBateaux.length;i=i+1)
				{
					if (listBateaux[i].id == id)
					{										
						var list = listBateaux.splice(i,1);
						break;
					}
				}
			});

			
			
			function initialiser()
			{
				socket.emit('id');					
			}
			
			function dessiner()
			{
				
				var sousMarin = new Image();
				sousMarin.src = 'sousMarin.svg';				
				ctx.clearRect(0, 0, canvas.width, canvas.height);//Cette fonction permet de réinitialiser notre canvas. Plus rien n'y est affiché.
				//C'est ici que toutes les manipulations sur le canvas se feront.
				var gradient = ctx.createLinearGradient(0,0,0,canvas.height);
				gradient.addColorStop(0,"#00BBFF");
				var time = new Date().getTime() / 10000;				
				gradient.addColorStop(Math.abs(time - Math.floor(time)-0.5)+0.5,"#0044EE");
				gradient.addColorStop(1,"#0022FF");	
				ctx.fillStyle = gradient;
				ctx.fillRect(0,0,canvas.width, canvas.height);		
				
				sousMarin.onload = function() {
					// dessiner tous les bateaux.
					for (var i=0; i<listBateaux.length;i=i+1)
					{											
						if (listBateaux[i].id == select)
						{
							ctx.beginPath();
							ctx.lineWidth="2";
							ctx.arc(listBateaux[i].x() * ratio, listBateaux[i].y() * ratio, 20, 0, 2 * Math.PI);
							ctx.stroke();
						}				
						var toto = listBateaux[i].x();
						
						ctx.drawImage(sousMarin, (listBateaux[i].x() - 2) * ratio, (listBateaux[i].y() - 2) * ratio, 4*ratio, 4*ratio);
											
					}
				}
				// dessiner tous les tirs
				for (var i=0; i<tirs.length;i=i+1)
				{
					var tempsTir = new Date().getTime() - tirs[i].time;
					if (tempsTir < 1000)
					{
						ctx.beginPath();
						ctx.arc(tirs[i].x * ratio,tirs[i].y * ratio,tempsTir/1000*5*ratio,0,Math.PI*2);
						ctx.fillStyle = "#EEFFEE";
						ctx.stroke();
					}			
				}
			}

        </script>
    </body>
</html>